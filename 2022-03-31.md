# 2022-03-31



# 
TLS  passthrough at Layer 4 Proxy

L4 Proxying:
    The ability for the proxy to only look at L4 content:
        . Ip Address
        . Port

    When  doing that, not allowed to look at the content. Specially because most of the time, the L7 content, such as body and headers are going to be encrypted.

Suppose you're a client, and there is a server. 
You conncet to the server through a Reverse Proxy. 
~> You do a SYN . What happens then?
    Does the RP iotself replies and at the background it stablishes a tcp between itself and the backend?
    Does it merely forwards the request?
    
    There are pros and cons for each approach.

After stablishing tcp connectiion, we need to stablish a tls connection. Who is gonna respond to your tls request?
As a reverse proxy, we can either
    . Respond to the client with your own certificate and tls parameters ( TLS Termination , need to put the private key and certificate in the reverse proxy, but you do not always own it. )
        .. This gives the RP the ability to crack the encryption and 
        .. technically not termination 
    . TSL Passthrough is when , through the (SNI? eSNI?) , the Reverse Proxy just forwards the tls request, but can't decrypt the  content; This makes it operate just like L4 proxy. 

https://www.youtube.com/watch?v=iLHhL-vAPqo



# 
Proxies

A proxy is a software that makes a request on behalf of a client. 


Use cases:

    Block Websites
        Some enterprises and ISP use proxies to block unwanted  websites. 
    
    Caching
    
    Anonymity: The final destination does not known the originating client ( Just transfers anonimity, since the proxy is now the only who  knows ). 

    Logging: 
        Can log everybody requests, 

    Microservices
        Especially side car proxies. Make it take care of networking stuff, such as upgrading http protocols, circuit breaking, 

Take your requests, passes it. 
Thus, the proxy needs to look at the data. 





Reverse Proxies
    
    The reverse of a proxy: In a normal proxy, the server does not know the client. In a reverse proxy, the client does not known the final destination server. 

    
    Use Cases

        Caching

        Load Balancing
            

        Ingress:
            Hey, you talk to me sir,  and if you wanna access the pictures api, it can route requests. 

        Canary
            Try out new versions by sending small amounts of traffic to them. 

        Microservices
            
    

    HAProxy
    Envoy
    Ngins
    Istio
    Linkerd
    Caddy

Your final destination as a user, but you do no tknow which server  you're hitting. 

Can a proxy and a reverse proxy be used at the same time?
    . yes, this is called a service mesh
    . Used in microservices architectures to build the networking features of the application in the proxy, instead of making the application worrry about 
    timeouts and circuits breaking

Can i use a proxy instead of bpn for annonimity?
    . Yes, but usually vpns are more secure since they operate at a lower level, and can see only your domain
    . Some proxies can see not only the domain, if they're  TLS-terminating . 
        .. Go to the padlock and see that the content is being served by the final destination, not the proxy. 
    . VPNS just transfer your anonimity from the isp to the vpn. 


Can i use proxxy for traffic other than http?
    yes,. there are multiple types of proxy, like socks proxy, used for tunnelings, there are http proxy, that only tunnels for https;.

https://www.youtube.com/watch?v=SqqrOspasag
#





https://www.youtube.com/watch?v=SqqrOspasag&list=PLQnljOFTspQVMeBmWI2AhxULWEeo7AaMC


# L4 vs L7 reverse proxies
    

L4 ( TCP / Stream ): Packet or Stream Proxying 
L7 ( HTTP ): Application Layer Proxying 

For a L7 proxy, it needs to understand the request, 
    Each re3quest has its own connection
    which means that it can only proxy the request after acking all underlying packets. The same goes for the request. 

    Further requests in the same connection can potentially stablish new connections, with different servers, since http is a stateless protocol. 

For a L4 Proxy
    it doesn't need to wait for the assembly 
    of the whole request: Since it doesn't need to know details, it can immediatelly send the packets to the downstream server.

    Additionally, further requests re-utilize the same previous stablished tcp connection: TCP is NOT a stateless protocol. 


We can't do intelligent things while proxying blindly. 

Can we do a time diagram of these? [[expand]]



How about TLS?
    
    A Layer 4 proxy will look at tls requests  and just transparently pass it .
        . Only one implementation. We can also terminate TLS 
    

https://www.youtube.com/watch?v=ylkAc9wmKhc

#


    

TCP Handshake 
    


Every packet sent has to be followed by a acknowledgement. 
Each packet has a unique identifier, called a sequence number.  They're also used to handle out of order packets. 
How do we know which is the first sequence number, though? THese need to be coordinated, which happens through the tcp handshake. 
    . We don't start from the same sequence every time to prevent attacks such as replay attacks and syn attacks. 
    . Less hints are better. 

The first step happens at the client. It sends a SYN request to the server, containing its own sequence number. 
The server then responds with a requests: An SYNACK  containing a syn of its own sequence number, and a ack of the client sequence number. 
To finish, the client sends an ACK containing the server sequence number. 

Each ACK contains one value: The ack of the packet seuqence number summed with the packet length. 






https://www.youtube.com/watch?v=bW_BILl7n0Y

#


TLS Handhake

Agree To a key. 
    We need the cient and the server to use the same number. 
    
    We can't just generate one and send it over, otherwise some party in the middle could sniff it. 


    Diffie Helman 
        Key Exchange Algorithmn 
            Enables to exhange keys without middle parts knwing 

The client comes up with a private number X, and a public number G. 

The client will send the "Client Hello". It contains 
G and G^X , alongside its supported encryptions, and some tsl extensions ( ALNP ) , such as http 2, stapling , sni, encrypted sni. 

The  server then creates a number, Y, and replies with G^Y, alogside the agreed encryption scheme. 

Then , both server and client use ( G^x ) ^ y = ( G ^ y) ^ x = G^( x * y  ) as a secret number. 


there is something to do with another variable used to take the modulo that makes it impossible to derive x back from G and G ^ x. [[expand]]
Public-Key Encryption schemes can be MITM , but we solve this here by the use of certificates [[expand]]
 

https://www.youtube.com/watch?v=IE0QLCcOr0I
https://www.youtube.com/watch?v=rKVCTVAHK7k


# 

VPNS
https://www.youtube.com/watch?v=JIA4ca0afnY


Normally, whern connecting to a site, we first do a dns lookup to find the IP address of the domain.
With the IP address, it stablishes a tcp connection, binded to a specific port in the client and another and the server. 

When sending a request, we translate it into packets, and shove it inside a IP packet. 
An IP Packet has just a source and destination ip. 
IP isn't secure. Anyone in the route to yyour destination, such as your ISP, can know where you're going to. 
We can secure IP ( IPSec ) : A negotiation protocol between hosts. Once they exchange keys, they encrypt the whole IP packet, which means that every other protocol that goes above it gets encrypted for free. 
To get around addressability, we put this encrypted packet inside another ip packet, addressed to the host ( VPN )

IPSec is easily identifiable. 
    does this means isp's could block vpns? [[expand
    ]]


why we can't use mac addresses? because mac addreses are random, that is: there are no routability to them. To send a request to a mac address you'd need to scan the entire internet. 



# NPM 

Very shady because no need for any kind of authentication. Can run some scripts automatically by using some "preinstall" function


# 
ALG Application layer gateay
nat slipstreaming
arp spoofing attack




# 
https://www.youtube.com/watch?v=qpC1YH0FhuY
